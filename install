#!/bin/bash
current_date_time=$(date)
rc_file=$1
tag="$2"
publickey=$3

required_servers=3

pvtkey="${publickey%.pub}"
current_dir="$(pwd)"
pvtkey_path="${current_dir}/${pvtkey}"

echo "$current_date_time Starting deployment with tag:$tag using $rc_file for credentials."
source $rc_file

# Define variables
name_of_the_network="${tag}_network"
name_of_the_subnet="${tag}_subnet"
name_of_the_keypair="${tag}_key"
name_of_the_router="${tag}_router"
name_of_the_securitygroup="${tag}_security_group"
haproxy_server1="${tag}_HAproxy1"
haproxy_server2="${tag}_HAproxy2"
bastion_server="${tag}_bastion"
server_name="${tag}_dev"
vport_name="${tag}_vport" #virtual ip port name

sshconfig="config"
hostsfile="hosts"
vport_file="vipaddr"

##########        SETTING UP NETWORK               ###########################

build_keypairs()
{
        # Check if keypair exists
        existing_keypairs=$(openstack keypair list -f value --column Name)

        if echo "$existing_keypairs" | grep -qFx $name_of_the_keypair; then
                        echo "$(date) Keypair: Already exists $name_of_the_keypair"
                        echo "$(date) Keypair: The existing keypairs are: $existing_keypairs"
        else
                        # Create Keypair
                        Created_keypair=$(openstack keypair create --public-key "$publickey" "$name_of_the_keypair" )
                        echo "$(date) Keypair: Created keypair $name_of_the_keypair"
        fi
}

build_securityGrp()
{
        # check if security group already exists
        existing_security_groups=$(openstack security group list --tag $tag -f value)
        # create security group
        if [[ -z "$existing_security_groups" ||  "$existing_security_groups" != *"$name_of_the_securitygroup"* ]]
        then
                        Created_security_group=$(openstack security group create --tag $tag $name_of_the_securitygroup -f json)
                        rule1=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 22 --protocol tcp --ingress $name_of_the_securitygroup)
                        rule2=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 80 --protocol icmp --ingress $name_of_the_securitygroup)
                        rule3=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 5000 --protocol tcp --ingress $name_of_the_securitygroup)
                        rule4=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 8080 --protocol tcp --ingress $name_of_the_securitygroup)
                        rule5=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 6000 --protocol udp --ingress $name_of_the_securitygroup)
                        rule6=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 9090 --protocol tcp --ingress $name_of_the_securitygroup)
                        rule7=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 9100 --protocol tcp --ingress $name_of_the_securitygroup)
                        rule8=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 3000 --protocol tcp --ingress $name_of_the_securitygroup)
                        rule9=$(openstack security group rule create --remote-ip 0.0.0.0/0 --dst-port 161 --protocol udp --ingress $name_of_the_securitygroup)
                        rule10=$(openstack security group rule create --protocol 112 $name_of_the_securitygroup) #VVRP protocol

                        echo "$(date) Security Group: Created $name_of_the_securitygroup"
        else
                        echo "$(date) Security Group: Already exists $name_of_the_securitygroup"
        fi
}
